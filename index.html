<!doctype html>
const near = getNearbyNpc();
if(near){
if(near.shop){ shopUI.open = true; shopUI.cursor = 0; }
startDialog(near.text);
near.interacted = true;
}
keys['z']=false; keys['enter']=false;
}


// Open inventory
if(keys['x']){ invUI.open = true; invUI.cursor = 0; keys['x']=false; }
// Quick open shop if near and press c
if(keys['c']){ const near = getNearbyNpc(); if(near && near.shop){ shopUI.open=true; shopUI.cursor=0; } keys['c']=false; }
}


function buySelected(){
const s = shopStock[shopUI.cursor];
if(!s) return;
if(player.gold >= s.price && s.qty > 0){
player.gold -= s.price; s.qty--; player.inventory[s.name] = (player.inventory[s.name]||0) + 1; startDialog(['Compra efetuada: ' + s.name]);
} else startDialog(['Você não tem ouro suficiente.']);
}


function useInventoryItem(itemName){
if(!itemName) return;
if(player.inventory[itemName] > 0){
if(itemName === 'Potion'){
player.hp = Math.min(player.maxHp, player.hp + 8);
player.inventory[itemName] -= 1; if(player.inventory[itemName] <= 0) delete player.inventory[itemName];
startDialog(['Usou ' + itemName + '. +8 HP']);
} else {
startDialog(['Usou ' + itemName + ' (efeito placeholder)']);
player.inventory[itemName] -= 1; if(player.inventory[itemName] <= 0) delete player.inventory[itemName];
}
} else startDialog(['Você não tem este item.']);
}


function render(){
// clear
ctx.clearRect(0,0,W,H);
// background rectangle (for nicer framing)
ctx.fillStyle = '#071018'; ctx.fillRect(0,0,W,H);


drawMap();


// draw NPCs
for(const n of npcs) drawNpc(n);


// draw player
drawPlayer();


// UI overlay
drawUI();
}


// initial intro dialog with guide if close to start
const startNear = getNearbyNpc();
if(!startNear){
// if player not near guide, move guide close and start dialog when player approaches
}
// For first-time players, automatically trigger the guide if the player is near
for(const n of npcs){ if(n.id==='guide'){ const dx = Math.abs(player.x - n.x), dy = Math.abs(player.y - n.y); if(dx < TILE*1.2 && dy < TILE*1.2){ startDialog(n.text); n.interacted=true; } } }


// small helper: show a blinking marker above NPCs you can talk to
(function npcMarkerLoop(){
let t=0; setInterval(()=>{ t+=0.12; for(const n of npcs){ n.marker = Math.abs(Math.sin(t))>0.5; } }, 120);
})();


// Accessibility: simple on-screen hints when dialog finishes
// --- end of script ---
</script>
</body>
</html>
